---
- hosts: localhost
  connection: local
  become: yes
  pre_tasks:
    - name: pre install docker-py
      pip:
        name: docker
        state: latest
  tasks:
    - name: initialize docker containers for tests
      docker_container:
        name: "node0{{ item }}"
        recreate: yes
        image: bpetit:systemd-base
        state: started
        auto_remove: yes
        detach: True
        command: "tail -f /dev/null &"
        interactive: yes
      with_sequence: count=3
      register: init_result
    - debug: var=init_result
    - debug:
        var: "{{ item }}"
      with_items: "{{ init_result.results }}"
    - name: generate inventory
      template:
        src: inventory_template.j2
        dest: cluster_inventory
    - name: get the subnet address of the docker bridge network
      shell: "{% raw %}docker network inspect bridge --format '{{ (index .IPAM.Config 0).Subnet }}' {% endraw %}"
      register: result
    - debug: var=result
    - name: pre-configure internet connectivity for containers
      iptables:
        table: nat
        chain: POSTROUTING
        jump: MASQUERADE
        source: "{{ result.stdout }}"
