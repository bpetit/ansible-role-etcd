---
- hosts: localhost
  connection: local
  become: yes
  pre_tasks:
    - name: update apt cache
      apt:
        update_cache: yes
    - name: pre install requirements
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - ipcalc
        - lxc
        - lxc-dev
        - lxc-templates
  tasks:
    - name: initialize docker containers for tests
      lxc_container:
        name: "node0{{ item }}"
        container_log: true
        template: debian
        state: started
        template_options: --release stretch
      with_sequence: count=3
      register: init_result
    - debug: var=init_result
    - debug:
        var: "{{ item }}"
      with_items: "{{ init_result.results }}"
    - name: generate inventory
      template:
        src: inventory_template.j2
        dest: cluster_inventory
    - name: get the subnet address of the lxc bridge network
      shell: "ipcalc -n $(ip a s lxcbr0 | grep \"inet \" | aws '{ print $2 }') | grep Network | awk '{ print $2 }'"
    - debug: var=result
    - name: pre-configure internet connectivity for containers
      iptables:
        table: nat
        chain: POSTROUTING
        jump: MASQUERADE
        source: "{{ result.stdout }}"
